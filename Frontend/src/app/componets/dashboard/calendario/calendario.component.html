<div class="container-fluid p-4">
  <header class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h4">Calendario de Reservas</h2>
    <div class="d-flex align-items-center">
      <!-- Filtro por Sala -->
      <div class="me-3">
        <select class="form-select form-select-sm" (change)="onSalaFilterChange($event)">
          <option [ngValue]="null">Todas las salas</option>
          <option *ngFor="let sala of salas" [value]="sala.id">{{ sala.nombre }}</option>
        </select>
      </div>
      <!-- Controles de Vista -->
      <div class="btn-group">
        <button class="btn btn-outline-secondary" (click)="setView(CalendarView.Month)" [class.active]="view === CalendarView.Month">Mes</button>
        <button class="btn btn-outline-secondary" (click)="setView(CalendarView.Week)" [class.active]="view === CalendarView.Week">Semana</button>
        <button class="btn btn-outline-secondary" (click)="setView(CalendarView.Day)" [class.active]="view === CalendarView.Day">Día</button>
      </div>
    </div>
  </header>

  <div class="bg-white p-4 rounded shadow-sm">
    <div [ngSwitch]="view">
      <mwl-calendar-month-view
        *ngSwitchCase="'month'"
        [viewDate]="viewDate"
        [events]="filteredEvents"
        (dayClicked)="dayClicked($event.day)"
        (eventClicked)="handleEventClick($event.event)"
        (eventsChanged)="refresh.next()"
      ></mwl-calendar-month-view>
      <mwl-calendar-week-view
        *ngSwitchCase="'week'"
        [viewDate]="viewDate"
        [events]="filteredEvents"
        (eventClicked)="handleEventClick($event.event)"
        (eventsChanged)="refresh.next()"
      ></mwl-calendar-week-view>
      <mwl-calendar-day-view
        *ngSwitchCase="'day'"
        [viewDate]="viewDate"
        [events]="filteredEvents"
        (eventClicked)="handleEventClick($event.event)"
        (eventsChanged)="refresh.next()"
      ></mwl-calendar-day-view>
    </div>
  </div>
</div>

<!-- Botón Flotante para Crear Reserva -->
<button class="btn btn-primary btn-lg rounded-circle shadow fab" (click)="openModal()">
  +
</button>

<!-- Modal para Crear/Editar Reserva con Bootstrap -->
<div class="modal fade" [class.show]="isModalVisible" [ngStyle]="{'display': isModalVisible ? 'block' : 'none'}" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nueva Reserva</h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="reservaForm">
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="titulo" class="form-label">Título de la Reunión</label>
              <input id="titulo" formControlName="titulo" type="text" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label for="sala_id" class="form-label">Sala</label>
              <select id="sala_id" formControlName="sala_id" class="form-select">
                <option [ngValue]="null" disabled>Selecciona una sala</option>
                <option *ngFor="let sala of salas" [ngValue]="sala.id">{{ sala.nombre }}</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="fecha_inicio" class="form-label">Inicio</label>
              <input id="fecha_inicio" formControlName="fecha_inicio" type="datetime-local" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
              <label for="fecha_fin" class="form-label">Fin</label>
              <input id="fecha_fin" formControlName="fecha_fin" type="datetime-local" class="form-control">
            </div>
          </div>

          <div class="mb-3">
            <label for="descripcion" class="form-label">Descripción (Opcional)</label>
            <textarea id="descripcion" formControlName="descripcion" class="form-control" rows="2"></textarea>
          </div>

          <div class="mb-3">
            <label for="invitados" class="form-label">Invitados</label>
            <div class="autocomplete-container">
              <input id="invitados" formControlName="invitadoSearch" type="text" (input)="search($event)" class="form-control" placeholder="Busca por nombre o correo...">
              <div class="suggestions list-group" *ngIf="(searchSuggestions$ | async) as suggestions">
                <button type="button" *ngFor="let suggestion of suggestions" class="list-group-item list-group-item-action d-flex align-items-center" (click)="addInvitado(suggestion)">
                  <img [src]="suggestion.avatar_url || 'assets/icon/user.png'" class="rounded-circle me-2" style="width: 24px; height: 24px;">
                  {{ suggestion.nombre }} <small class="text-muted ms-auto">({{ suggestion.email }})</small>
                </button>
              </div>
            </div>
            <div class="pills-container mt-2">
              <span *ngFor="let invitado of invitados" class="badge rounded-pill text-bg-secondary me-1 fw-normal d-inline-flex align-items-center">
                <img [src]="invitado.avatar_url || 'assets/icon/user.png'" class="rounded-circle me-1" style="width: 18px; height: 18px;">
                {{ invitado.nombre }}
                <button type="button" class="btn-close btn-close-white ms-2" (click)="removeInvitado(invitado)" style="font-size: 0.65em;"></button>
              </span>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Equipamiento Requerido</label>
            <div class="p-3 bg-light border rounded" formArrayName="equipos">
              <div class="row">
                <div *ngFor="let equipo of equipos; let i = index" class="col-md-6">
                  <div class="form-check">
                    <input [formControlName]="i" type="checkbox" class="form-check-input" id="equipo-{{i}}">
                    <label class="form-check-label" for="equipo-{{i}}">{{ equipo.nombre }}</label>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="onSubmit()" [disabled]="reservaForm.invalid">Crear Reserva</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="isModalVisible"></div>
